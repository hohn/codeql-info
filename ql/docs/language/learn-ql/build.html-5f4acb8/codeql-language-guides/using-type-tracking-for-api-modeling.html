<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Using type tracking for API modeling &#8212; CodeQL</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css?v=93459777" />
    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Abstract syntax tree classes for working with JavaScript and TypeScript programs" href="abstract-syntax-tree-classes-for-working-with-javascript-and-typescript-programs.html" />
    <link rel="prev" title="Specifying additional remote flow sources for JavaScript" href="specifying-additional-remote-flow-sources-for-javascript.html" />

<title>CodeQL docs</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="../_static/custom.css" type="text/css" />
<link rel="stylesheet" href="../_static/primer.css" type="text/css" />


  </head><body>
<header class="Header">
    <div class="Header-item--full">
        <a href="https://codeql.github.com/docs" class="Header-link f2 d-flex flex-items-center">
            <!-- <%= octicon "mark-github", class: "mr-2", height: 32 %> -->
            <svg height="32" class="octicon octicon-mark-github mr-2" viewBox="0 0 16 16" version="1.1" width="32"
                aria-hidden="true">
                <path fill-rule="evenodd"
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z">
                </path>
            </svg>
            <span class="hide-sm">CodeQL documentation</span>
        </a>
    </div>
    <div class="Header-item hide-sm hide-md">
        <script src="https://addsearch.com/js/?key=93b4d287e2fc079a4089412b669785d5&categories=!0xhelp.semmle.com,0xcodeql.github.com,1xdocs,1xcodeql-standard-libraries,1xcodeql-query-help"></script>
    </div>
    <div class="Header-item">

        <details class="dropdown details-reset details-overlay d-inline-block">
            <summary class="btn bg-gray-dark text-white border" aria-haspopup="true">
                CodeQL resources
                <div class="dropdown-caret"></div>
            </summary>

            <ul class="dropdown-menu dropdown-menu-se dropdown-menu-dark">
                <li><a class="dropdown-item" href="https://codeql.github.com/docs/codeql-overview">CodeQL overview</a></li>
                <li class="dropdown-divider" role="separator"></li>
                <div class="dropdown-header">
                    CodeQL tools
                </div>
                <li><a class="dropdown-item" href="https://codeql.github.com/docs/codeql-for-visual-studio-code">CodeQL for VS Code</a>
                <li><a class="dropdown-item" href="https://codeql.github.com/docs/codeql-cli">CodeQL CLI</a>
                </li>
                <li class="dropdown-divider" role="separator"></li>
                <div class="dropdown-header">
                    CodeQL guides
                </div>
                <li><a class="dropdown-item" href="https://codeql.github.com/docs/writing-codeql-queries">Writing CodeQL queries</a></li>
                <li><a class="dropdown-item" href="https://codeql.github.com/docs/codeql-language-guides">CodeQL language guides</a>
                <li class="dropdown-divider" role="separator"></li>
                <div class="dropdown-header">
                    Reference docs
                </div>
                <li><a class="dropdown-item" href="https://codeql.github.com/docs/ql-language-reference/">QL language
                        reference</a>
                <li><a class="dropdown-item" href="https://codeql.github.com/codeql-standard-libraries">CodeQL
                        standard-libraries</a>
                <li><a class="dropdown-item" href="https://codeql.github.com/codeql-query-help">CodeQL
                        query help</a>
                <li class="dropdown-divider" role="separator"></li>
                <div class="dropdown-header">
                    Source files
                </div>
                <li><a class="dropdown-item" href="https://github.com/github/codeql">CodeQL repository</a>
            </ul>
        </details>

    </div>

</header>
<main class="bg-gray-light clearfix">
<nav class="SideNav position-sticky top-0 col-lg-3 col-md-3 float-left p-4 hide-sm hide-md overflow-y-auto">

    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../codeql-overview/index.html">CodeQL overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../codeql-for-visual-studio-code/index.html">CodeQL for Visual Studio Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../codeql-cli/index.html">CodeQL CLI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../writing-codeql-queries/index.html">Writing CodeQL queries</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">CodeQL language guides</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="codeql-for-cpp.html">CodeQL for C and C++</a></li>
<li class="toctree-l2"><a class="reference internal" href="codeql-for-csharp.html">CodeQL for C#</a></li>
<li class="toctree-l2"><a class="reference internal" href="codeql-for-go.html">CodeQL for Go</a></li>
<li class="toctree-l2"><a class="reference internal" href="codeql-for-java.html">CodeQL for Java</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="codeql-for-javascript.html">CodeQL for JavaScript</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="basic-query-for-javascript-code.html">Basic query for JavaScript code</a></li>
<li class="toctree-l3"><a class="reference internal" href="codeql-library-for-javascript.html">CodeQL library for JavaScript</a></li>
<li class="toctree-l3"><a class="reference internal" href="codeql-library-for-typescript.html">CodeQL library for TypeScript</a></li>
<li class="toctree-l3"><a class="reference internal" href="analyzing-data-flow-in-javascript-and-typescript.html">Analyzing data flow in JavaScript and TypeScript</a></li>
<li class="toctree-l3"><a class="reference internal" href="using-flow-labels-for-precise-data-flow-analysis.html">Using flow labels for precise data flow analysis</a></li>
<li class="toctree-l3"><a class="reference internal" href="specifying-additional-remote-flow-sources-for-javascript.html">Specifying additional remote flow sources for JavaScript</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Using type tracking for API modeling</a></li>
<li class="toctree-l3"><a class="reference internal" href="abstract-syntax-tree-classes-for-working-with-javascript-and-typescript-programs.html">Abstract syntax tree classes for working with JavaScript and TypeScript programs</a></li>
<li class="toctree-l3"><a class="reference internal" href="data-flow-cheat-sheet-for-javascript.html">Data flow cheat sheet for JavaScript</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="codeql-for-python.html">CodeQL for Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="codeql-for-ruby.html">CodeQL for Ruby</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ql-language-reference/index.html">QL language reference</a></li>
</ul>


</nav>


<div class="body col-sm-12 col-md-9 col-lg-9 float-left border-left">

    <div class="hide-lg hide-xl px-4 pt-4">
        
<div class="related" role="navigation" aria-label="related navigation">
    <ul>
        <li class="nav-item nav-item-0"><a href="../contents.html">CodeQL</a> &#187;</li>
        <li class="nav-item nav-item-1"><a href="index.html"
                >CodeQL language guides</a> &#187;</li>
        <li class="nav-item nav-item-2"><a href="codeql-for-javascript.html"
                accesskey="U">CodeQL for JavaScript</a> &#187;</li> 
    </ul>
</div>
    </div>

    <article class="p-4 col-lg-10 col-md-10 col-sm-12">
        
  <section id="using-type-tracking-for-api-modeling">
<span id="id1"></span><h1>Using type tracking for API modeling<a class="headerlink" href="#using-type-tracking-for-api-modeling" title="Link to this heading">¶</a></h1>
<p>You can track data through an API by creating a model using the CodeQL type-tracking library for JavaScript.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The type-tracking library makes it possible to track values through properties and function calls,
usually to recognize method calls and properties accessed on a specific type of object.</p>
<p>This is an advanced topic and is intended for readers already familiar with the
<a class="reference external" href="https://codeql.github.com/docs/codeql-language-guides/analyzing-data-flow-in-javascript-and-typescript/#source-nodes">SourceNode</a> class as well as
<a class="reference external" href="https://codeql.github.com/docs/codeql-language-guides/analyzing-data-flow-in-javascript-and-typescript/#using-global-taint-tracking">taint tracking</a>.
For TypeScript analysis also consider reading about <a class="reference external" href="https://codeql.github.com/docs/codeql-language-guides/codeql-library-for-typescript/#static-type-information">static type information</a> first.</p>
</section>
<section id="the-problem-of-recognizing-method-calls">
<h2>The problem of recognizing method calls<a class="headerlink" href="#the-problem-of-recognizing-method-calls" title="Link to this heading">¶</a></h2>
<p>We’ll start with a simple model of the <a class="reference external" href="https://firebase.google.com/docs/reference/js/firebase.database">Firebase API</a> and gradually build on it to use type tracking.
Knowledge of Firebase is not required.</p>
<p>Suppose we wish to find places where data is written to a Firebase database, as
in the following example:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">);</span>
<span class="nx">ref</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;Rain&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;-- find this call</span>
</pre></div>
</div>
<p>A simple way to do this is just to find
all method calls named “<code class="docutils literal notranslate"><span class="pre">set</span></code>”:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>import javascript
import DataFlow

MethodCallNode firebaseSetterCall() {
  result.getMethodName() = &quot;set&quot;
}
</pre></div>
</div>
<p>The obvious problem with this is that it finds calls to <em>all</em> methods named <code class="docutils literal notranslate"><span class="pre">set</span></code>,
many of which are unrelated to Firebase.</p>
<p>Another approach is to use local data flow to match the chain of calls that led to this call:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>MethodCallNode firebaseSetterCall() {
  result = globalVarRef(&quot;firebase&quot;)
      .getAMethodCall(&quot;database&quot;)
      .getAMethodCall(&quot;ref&quot;)
      .getAMethodCall(&quot;set&quot;)
}
</pre></div>
</div>
<p>This will find the <code class="docutils literal notranslate"><span class="pre">set</span></code> call from the example, but no spurious, unrelated <code class="docutils literal notranslate"><span class="pre">set</span></code> method calls.
We can split it up so each step is its own predicate:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebase() {
  result = globalVarRef(&quot;firebase&quot;)
}

SourceNode firebaseDatabase() {
  result = firebase().getAMethodCall(&quot;database&quot;)
}

SourceNode firebaseRef() {
  result = firebaseDatabase().getAMethodCall(&quot;ref&quot;);
}

MethodCallNode firebaseSetterCall() {
  result = firebaseRef().getAMethodCall(&quot;set&quot;)
}
</pre></div>
</div>
<p>The code above is equivalent to the previous version,
but it’s easier to tinker with the individual steps.</p>
<p>The downside is that the model relies entirely on local data flow,
which means it won’t look through properties and function calls.
For instance, <code class="docutils literal notranslate"><span class="pre">firebaseSetterCall()</span></code> fails to find anything in this example:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">getDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">();</span>
<span class="p">}</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">ref</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getDatabase</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">);</span>
<span class="nx">ref</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s2">&quot;Rain&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>Notice that the predicate <code class="docutils literal notranslate"><span class="pre">firebaseDatabase()</span></code> still finds the call to <code class="docutils literal notranslate"><span class="pre">firebase.database()</span></code>,
but not the <code class="docutils literal notranslate"><span class="pre">getDatabase()</span></code> call.
This means <code class="docutils literal notranslate"><span class="pre">firebaseRef()</span></code> has no result, which in turn means <code class="docutils literal notranslate"><span class="pre">firebaseSetterCall()</span></code> has no result.</p>
<p>As a simple remedy, let’s try to make <code class="docutils literal notranslate"><span class="pre">firebaseDatabase()</span></code> recognize the <code class="docutils literal notranslate"><span class="pre">getDatabase()</span></code> call:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebaseDatabase() {
  result = firebase().getAMethodCall(&quot;database&quot;)
  or
  result.(CallNode).getACallee().getAReturn().getALocalSource() = firebaseDatabase()
}
</pre></div>
</div>
<p>The second clause ensures <code class="docutils literal notranslate"><span class="pre">firebaseDatabase()</span></code> finds not only <code class="docutils literal notranslate"><span class="pre">firebase.database()</span></code> calls,
but also calls to functions that <em>return</em> <code class="docutils literal notranslate"><span class="pre">firebase.database()</span></code>, such as <code class="docutils literal notranslate"><span class="pre">getDatabase()</span></code> seen above.
It’s recursive, so it handles flow out of any number of nested function calls.</p>
<p>However, it still only tracks <em>out</em> of functions, not <em>into</em> functions through parameters, nor through properties.
Instead of adding these steps by hand, we’ll use type tracking.</p>
</section>
<section id="type-tracking-in-general">
<h2>Type tracking in general<a class="headerlink" href="#type-tracking-in-general" title="Link to this heading">¶</a></h2>
<p>Type tracking is a generalization of the above pattern, where a predicate matches the value to track,
and has a recursive clause that tracks the flow of that value.
But instead of us having to deal with function calls/returns and property reads/writes,
all of these steps are included in a single predicate,
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/dataflow/Sources.qll/predicate.Sources$SourceNode$track.2.html">SourceNode.track</a>,
to be used with the companion class
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/dataflow/TypeTracking.qll/type.TypeTracking$TypeTracker.html">TypeTracker</a>.</p>
<p>Predicates that use type tracking usually conform to the following general pattern, which we explain below:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode myType(TypeTracker t) {
  t.start() and
  result = /* SourceNode to track */
  or
  exists(TypeTracker t2 |
    result = myType(t2).track(t2, t)
  )
}

SourceNode myType() {
  result = myType(TypeTracker::end())
}
</pre></div>
</div>
<p>We’ll apply the pattern to our example model and use that to explain what’s going on.</p>
</section>
<section id="tracking-the-database-instance">
<h2>Tracking the database instance<a class="headerlink" href="#tracking-the-database-instance" title="Link to this heading">¶</a></h2>
<p>Applying the above pattern to the <code class="docutils literal notranslate"><span class="pre">firebaseDatabase()</span></code> predicate we get the following:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebaseDatabase(TypeTracker t) {
  t.start() and
  result = firebase().getAMethodCall(&quot;database&quot;)
  or
  exists(TypeTracker t2 |
    result = firebaseDatabase(t2).track(t2, t)
  )
}

SourceNode firebaseDatabase() {
  result = firebaseDatabase(TypeTracker::end())
}
</pre></div>
</div>
<p>There are now two predicates named <code class="docutils literal notranslate"><span class="pre">firebaseDatabase</span></code>.
The one with the <code class="docutils literal notranslate"><span class="pre">TypeTracker</span></code> parameter is the one actually doing the global data flow tracking
– the other predicate exposes the result in a convenient way.</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">TypeTracker</span> <span class="pre">t</span></code> parameter is a summary of the steps needed to track the value of interest to the resulting data flow node.</p>
<p>In the base case, when matching <code class="docutils literal notranslate"><span class="pre">firebase.database()</span></code>, we use <code class="docutils literal notranslate"><span class="pre">t.start()</span></code> to indicate that no steps were needed, that is,
this is the starting point of type tracking:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>t.start() and
result = firebase().getAMethodCall(&quot;database&quot;)
</pre></div>
</div>
<p>In the recursive case, we apply the <code class="docutils literal notranslate"><span class="pre">track</span></code> predicate on a previously-found Firebase database node, such as <code class="docutils literal notranslate"><span class="pre">firebase.database()</span></code>.
The <code class="docutils literal notranslate"><span class="pre">track</span></code> predicate maps this to a successor of that node, such as <code class="docutils literal notranslate"><span class="pre">getDatabase()</span></code>, and
binds <code class="docutils literal notranslate"><span class="pre">t</span></code> to the continuation of <code class="docutils literal notranslate"><span class="pre">t2</span></code> with this extra step included:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>exists(TypeTracker t2 |
  result = firebaseDatabase(t2).track(t2, t)
)
</pre></div>
</div>
<p>To understand the role of <code class="docutils literal notranslate"><span class="pre">t</span></code> here, note that type tracking can step <em>into</em> a property, which means
the data flow node returned from <code class="docutils literal notranslate"><span class="pre">track</span></code> is not necessarily a Firebase database instance, it could be
an object <em>containing</em> a Firebase database in one of its properties.</p>
<p>For example, in the program below, the <code class="docutils literal notranslate"><span class="pre">firebaseDatabase(t)</span></code> predicate includes the <code class="docutils literal notranslate"><span class="pre">obj</span></code> node in its result,
but with <code class="docutils literal notranslate"><span class="pre">t</span></code> recording the fact that the actual value being tracked is inside the <code class="docutils literal notranslate"><span class="pre">DB</span></code> property:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">DB</span><span class="o">:</span><span class="w"> </span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">()</span><span class="w"> </span><span class="p">};</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">obj</span><span class="p">.</span><span class="nx">DB</span><span class="p">;</span>
</pre></div>
</div>
<p>This brings us to the last predicate. This uses <code class="docutils literal notranslate"><span class="pre">TypeTracker::end()</span></code> to filter out
the paths where the Firebase database instance ended up inside a property of another object,
so it includes <code class="docutils literal notranslate"><span class="pre">db</span></code> but not <code class="docutils literal notranslate"><span class="pre">obj</span></code>:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebaseDatabase() {
  result = firebaseDatabase(TypeTracker::end())
}
</pre></div>
</div>
<p>Here’s see an example of what this can handle now:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">class</span><span class="w"> </span><span class="nx">Firebase</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>

<span class="w">  </span><span class="nx">setForecast</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">getDatabase</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span><span class="w"> </span><span class="c1">// found by firebaseSetterCall()</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="tracking-in-the-whole-model">
<h2>Tracking in the whole model<a class="headerlink" href="#tracking-in-the-whole-model" title="Link to this heading">¶</a></h2>
<p>We applied this pattern to <code class="docutils literal notranslate"><span class="pre">firebaseDatabase()</span></code> in the previous section, and it
can just as easily apply to the other predicates.
For reference, here’s our simple Firebase model with type tracking on every predicate:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebase(TypeTracker t) {
  t.start() and
  result = globalVarRef(&quot;firebase&quot;)
  or
  exists(TypeTracker t2 |
    result = firebase(t2).track(t2, t)
  )
}

SourceNode firebase() {
  result = firebase(TypeTracker::end())
}

SourceNode firebaseDatabase(TypeTracker t) {
  t.start() and
  result = firebase().getAMethodCall(&quot;database&quot;)
  or
  exists(TypeTracker t2 |
    result = firebaseDatabase(t2).track(t2, t)
  )
}

SourceNode firebaseDatabase() {
  result = firebaseDatabase(TypeTracker::end())
}

SourceNode firebaseRef(TypeTracker t) {
  t.start() and
  result = firebaseDatabase().getAMethodCall(&quot;ref&quot;)
  or
  exists(TypeTracker t2 |
    result = firebaseRef(t2).track(t2, t)
  )
}

SourceNode firebaseRef() {
  result = firebaseRef(TypeTracker::end())
}

MethodCallNode firebaseSetterCall() {
  result = firebaseRef().getAMethodCall(&quot;set&quot;)
}
</pre></div>
</div>
<p><a class="reference external" href="https://lgtm.com/query/1053770500827789481">Here</a> is a run of an example query using the model to find <cite>set</cite> calls on one of the Firebase sample projects.
It’s been modified slightly to handle a bit more of the API, which is beyond the scope of this tutorial.</p>
</section>
<section id="tracking-associated-data">
<h2>Tracking associated data<a class="headerlink" href="#tracking-associated-data" title="Link to this heading">¶</a></h2>
<p>By adding extra parameters to the type-tracking predicate, we can carry along
extra bits of information about the result.</p>
<p>For example, here’s a type-tracking version of <code class="docutils literal notranslate"><span class="pre">firebaseRef()</span></code>, which
tracks the string that was passed to the <code class="docutils literal notranslate"><span class="pre">ref</span></code> call:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebaseRef(string name, TypeTracker t) {
  t.start() and
  exists(CallNode call |
    call = firebaseDatabase().getAMethodCall(&quot;ref&quot;) and
    name = call.getArgument(0).getStringValue() and
    result = call
  )
  or
  exists(TypeTracker t2 |
    result = firebaseRef(name, t2).track(t2, t)
  )
}

SourceNode firebaseRef(string name) {
  result = firebaseRef(name, TypeTracker::end())
}

MethodCallNode firebaseSetterCall(string refName) {
  result = firebaseRef(refName).getAMethodCall(&quot;set&quot;)
}
</pre></div>
</div>
<p>So now we can use <code class="docutils literal notranslate"><span class="pre">firebaseSetterCall(&quot;forecast&quot;)</span></code> to find assignments to the forecast.</p>
</section>
<section id="back-tracking-callbacks">
<h2>Back-tracking callbacks<a class="headerlink" href="#back-tracking-callbacks" title="Link to this heading">¶</a></h2>
<p>The type-tracking predicates we’ve seen above all use <em>forward</em> tracking.
That is, they all start with some value of interest and ask “where does this flow?”.</p>
<p>Sometimes it’s more useful to work backwards, starting at the desired end-point and asking “what flows to here?”.</p>
<p>As a motivating example, we’ll extend our model to look for places where we <em>read</em> a value
from the database, as opposed to writing it.
Reading is an asynchronous operation and the result is obtained through a callback, for example:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">fetchForecast</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">().</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">updateReminders</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fetchForecast</span><span class="p">((</span><span class="nx">snapshot</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">forecast</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">snapshot</span><span class="p">.</span><span class="nx">val</span><span class="p">();</span><span class="w"> </span><span class="c1">// &lt;-- find this call</span>
<span class="w">    </span><span class="nx">addReminder</span><span class="p">(</span><span class="nx">forecast</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;Rain&quot;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;Umbrella&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Sunscreen&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The actual forecast is obtained by the call to <code class="docutils literal notranslate"><span class="pre">snapshot.val()</span></code>.</p>
<p>Looking for all method calls named <code class="docutils literal notranslate"><span class="pre">val</span></code> will in practice find many unrelated methods,
so we’ll use type tracking again to take the receiver type into account.</p>
<p>The receiver <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> is a parameter to a callback function, which ultimately escapes
into the <code class="docutils literal notranslate"><span class="pre">once()</span></code> call. We’ll extend our model from above to use back-tracking to find
all functions that flow into the <code class="docutils literal notranslate"><span class="pre">once()</span></code> call.
Backwards type tracking is not too different from forwards type tracking. The differences are:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">TypeTracker</span></code> parameter instead has type <code class="docutils literal notranslate"><span class="pre">TypeBackTracker</span></code>.</p></li>
<li><p>The call to <code class="docutils literal notranslate"><span class="pre">.track()</span></code> is instead a call to <code class="docutils literal notranslate"><span class="pre">.backtrack()</span></code>.</p></li>
<li><p>To ensure the initial value is a source node, a call to <code class="docutils literal notranslate"><span class="pre">getALocalSource()</span></code> is usually required.</p></li>
</ul>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebaseSnapshotCallback(string refName, TypeBackTracker t) {
  t.start() and
  result = firebaseRef(refName).getAMethodCall(&quot;once&quot;).getArgument(1).getALocalSource()
  or
  exists(TypeBackTracker t2 |
    result = firebaseSnapshotCallback(refName, t2).backtrack(t2, t)
  )
}

FunctionNode firebaseSnapshotCallback(string refName) {
  result = firebaseSnapshotCallback(refName, TypeBackTracker::end())
}
</pre></div>
</div>
<p>Now, <code class="docutils literal notranslate"><span class="pre">firebaseSnapshotCallback(&quot;forecast&quot;)</span></code> finds the function being passed to <code class="docutils literal notranslate"><span class="pre">fetchForecast</span></code>.
Based on that we can track the <code class="docutils literal notranslate"><span class="pre">snapshot</span></code> value and find the <code class="docutils literal notranslate"><span class="pre">val()</span></code> call itself:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode firebaseSnapshot(string refName, TypeTracker t) {
  t.start() and
  result = firebaseSnapshotCallback(refName).getParameter(0)
  or
  exists(TypeTracker t2 |
    result = firebaseSnapshot(refName, t2).track(t2, t)
  )
}

SourceNode firebaseSnapshot(string refName) {
  result = firebaseSnapshot(refName, TypeTracker::end())
}

MethodCallNode firebaseDatabaseRead(string refName) {
  result = firebaseSnapshot(refName).getAMethodCall(&quot;val&quot;)
}
</pre></div>
</div>
<p>With this addition, <code class="docutils literal notranslate"><span class="pre">firebaseDatabaseRead(&quot;forecast&quot;)</span></code> finds the call to <code class="docutils literal notranslate"><span class="pre">snapshot.val()</span></code> that contains the value of the forecast.</p>
<p><a class="reference external" href="https://lgtm.com/query/8761360814276109092">Here</a> is a run of an example query using the model to find <cite>val</cite> calls.</p>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>We have covered how to use the type-tracking library. To recap, use this template to define forward type-tracking predicates:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode myType(TypeTracker t) {
  t.start() and
  result = /* SourceNode to track */
  or
  exists(TypeTracker t2 |
    result = myType(t2).track(t2, t)
  )
}

SourceNode myType() {
  result = myType(TypeTracker::end())
}
</pre></div>
</div>
<p>Use this template to define backward type-tracking predicates:</p>
<div class="highlight-ql notranslate"><div class="highlight"><pre><span></span>SourceNode myType(TypeBackTracker t) {
  t.start() and
  result = (/* argument to track */).getALocalSource()
  or
  exists(TypeBackTracker t2 |
    result = myType(t2).backtrack(t2, t)
  )
}

SourceNode myType() {
  result = myType(TypeBackTracker::end())
}
</pre></div>
</div>
<p>Note that these predicates all return <code class="docutils literal notranslate"><span class="pre">SourceNode</span></code>,
so attempts to track a non-source node, such as an identifier or string literal,
will not work.
If this becomes an issue, see
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/dataflow/TypeTracking.qll/predicate.TypeTracking$TypeTracker$smallstep.2.html">TypeTracker.smallstep</a>.</p>
<p>Also note that the predicates taking a <code class="docutils literal notranslate"><span class="pre">TypeTracker</span></code> or <code class="docutils literal notranslate"><span class="pre">TypeBackTracker</span></code> can often be made <code class="docutils literal notranslate"><span class="pre">private</span></code>,
as they are typically only used as an intermediate result to compute the other predicate.</p>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h2>
<p>As mentioned, type tracking will track values in and out of function calls and properties,
but only within some limits.</p>
<p>For example, type tracking does not always track <em>through</em> functions. That is, if a value flows into a parameter
and back out of the return value, it might not be tracked back out to the call site again.
Here’s an example that the model from this tutorial won’t find:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span><span class="w"> </span><span class="nx">wrapDB</span><span class="p">(</span><span class="nx">database</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">db</span><span class="o">:</span><span class="w"> </span><span class="nx">database</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">wrapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wrapDB</span><span class="p">(</span><span class="nx">firebase</span><span class="p">.</span><span class="nx">database</span><span class="p">())</span>
<span class="nx">wrapper</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">ref</span><span class="p">(</span><span class="s2">&quot;forecast&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// &lt;-- not found</span>
</pre></div>
</div>
<p>This is an example of where <a class="reference external" href="https://codeql.github.com/docs/codeql-language-guides/analyzing-data-flow-in-javascript-and-typescript/#global-data-flow">data-flow configurations</a> are more powerful.</p>
</section>
<section id="when-to-use-type-tracking">
<h2>When to use type tracking<a class="headerlink" href="#when-to-use-type-tracking" title="Link to this heading">¶</a></h2>
<p>Type tracking and data-flow configurations are different solutions to the same
problem, each with their own tradeoffs.</p>
<p>Type tracking can be used in any number of predicates, which may depend on each other
in fairly unrestricted ways. The result of one predicate may be the starting
point for another. Type-tracking predicates may be mutually recursive.
Type-tracking predicates can have any number of extra parameters, making it possible, but optional,
to construct source/sink pairs. Omitting source/sink pairs can be useful when there is a huge number
of sources and sinks.</p>
<p>Data-flow configurations have more restricted dependencies but are more powerful in other ways.
For performance reasons,
the sources, sinks, and steps of a configuration should not depend on whether a flow path has been found using
that configuration or any other configuration.
In that sense, the sources, sinks, and steps must be configured “up front” and can’t be discovered on-the-fly.
The upside is that they track flow through functions and callbacks in some ways that type tracking doesn’t,
which is particularly important for security queries.
Also, path queries can only be defined using data-flow configurations.</p>
<p>Prefer type tracking when:</p>
<ul class="simple">
<li><p>Disambiguating generically named methods or properties.</p></li>
<li><p>Making reusable library components to be shared between queries.</p></li>
<li><p>The set of source/sink pairs is too large to compute or has insufficient information.</p></li>
<li><p>The information is needed as input to a data-flow configuration.</p></li>
</ul>
<p>Prefer data-flow configurations when:</p>
<ul class="simple">
<li><p>Tracking user-controlled data – use <a class="reference external" href="https://codeql.github.com/docs/codeql-language-guides/analyzing-data-flow-in-javascript-and-typescript/#using-global-taint-tracking">taint tracking</a>.</p></li>
<li><p>Differentiating between different kinds of user-controlled data – see “<a class="reference internal" href="using-flow-labels-for-precise-data-flow-analysis.html"><span class="doc">Using flow labels for precise data flow analysis</span></a>.”</p></li>
<li><p>Tracking transformations of a value through generic utility functions.</p></li>
<li><p>Tracking values through string manipulation.</p></li>
<li><p>Generating a path from source to sink – see “<a class="reference internal" href="../writing-codeql-queries/creating-path-queries.html#creating-path-queries"><span class="std std-ref">Creating path queries</span></a>.”</p></li>
</ul>
<p>Lastly, depending on the code base being analyzed, some alternatives to consider are:</p>
<ul class="simple">
<li><p>Using <a class="reference external" href="https://codeql.github.com/docs/codeql-language-guides/codeql-library-for-typescript/#static-type-information">static type information</a>,
if analyzing TypeScript code.</p></li>
<li><p>Relying on local data flow.</p></li>
<li><p>Relying on syntactic heuristics such as the name of a method, property, or variable.</p></li>
</ul>
</section>
<section id="type-tracking-in-the-standard-libraries">
<h2>Type tracking in the standard libraries<a class="headerlink" href="#type-tracking-in-the-standard-libraries" title="Link to this heading">¶</a></h2>
<p>Type tracking is used in a few places in the standard libraries:</p>
<ul class="simple">
<li><p>The <a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/DOM.qll/module.DOM$DOM.html">DOM</a> predicates,
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/DOM.qll/predicate.DOM$DOM$documentRef.0.html">documentRef</a>,
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/DOM.qll/predicate.DOM$DOM$locationRef.0.html">locationRef</a>, and
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/DOM.qll/predicate.DOM$DOM$domValueRef.0.html">domValueRef</a>,
are implemented with type tracking.</p></li>
<li><p>The <a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/frameworks/HTTP.qll/module.HTTP$HTTP.html">HTTP</a> server models, such as <a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/frameworks/Express.qll/module.Express$Express.html">Express</a>, use type tracking to track the installation of router handler functions.</p></li>
<li><p>The <a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/frameworks/Firebase.qll/module.Firebase$Firebase.html">Firebase</a> and
<a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/semmle/javascript/frameworks/SocketIO.qll/module.SocketIO$SocketIO.html">Socket.io</a> models use type tracking to track objects coming from their respective APIs.</p></li>
</ul>
</section>
<section id="further-reading">
<h2>Further reading<a class="headerlink" href="#further-reading" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/github/codeql/tree/main/javascript/ql/src">CodeQL queries for JavaScript</a></p></li>
<li><p><a class="reference external" href="https://github.com/github/codeql/tree/main/javascript/ql/examples">Example queries for JavaScript</a></p></li>
<li><p><a class="reference external" href="https://codeql.github.com/codeql-standard-libraries/javascript/">CodeQL library reference for JavaScript</a></p></li>
</ul>
<ul class="simple">
<li><p>“<a class="reference internal" href="../ql-language-reference/index.html#ql-language-reference"><span class="std std-ref">QL language reference</span></a>”</p></li>
<li><p>“<a class="reference internal" href="../codeql-overview/codeql-tools.html#codeql-tools"><span class="std std-ref">CodeQL tools</span></a>”</p></li>
</ul>
</section>
</section>


    </article>

    <!-- GitHub footer, with links to terms and privacy statement -->
    <div class="px-3 px-md-6 f6 py-4 d-sm-flex flex-justify-between flex-row-reverse flex-items-center border-top">
        <ul class="list-style-none d-flex flex-items-center mb-3 mb-sm-0 lh-condensed-ultra">
            <li class="mr-3">
                <a href="https://twitter.com/github" title="GitHub on Twitter" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 273.5 222.3" class="d-block" height="18">
                        <path
                            d="M273.5 26.3a109.77 109.77 0 0 1-32.2 8.8 56.07 56.07 0 0 0 24.7-31 113.39 113.39 0 0 1-35.7 13.6 56.1 56.1 0 0 0-97 38.4 54 54 0 0 0 1.5 12.8A159.68 159.68 0 0 1 19.1 10.3a56.12 56.12 0 0 0 17.4 74.9 56.06 56.06 0 0 1-25.4-7v.7a56.11 56.11 0 0 0 45 55 55.65 55.65 0 0 1-14.8 2 62.39 62.39 0 0 1-10.6-1 56.24 56.24 0 0 0 52.4 39 112.87 112.87 0 0 1-69.7 24 119 119 0 0 1-13.4-.8 158.83 158.83 0 0 0 86 25.2c103.2 0 159.6-85.5 159.6-159.6 0-2.4-.1-4.9-.2-7.3a114.25 114.25 0 0 0 28.1-29.1"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li class="mr-3">
                <a href="https://www.facebook.com/GitHub" title="GitHub on Facebook" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15.3 15.4" class="d-block" height="18">
                        <path
                            d="M14.5 0H.8a.88.88 0 0 0-.8.9v13.6a.88.88 0 0 0 .8.9h7.3v-6h-2V7.1h2V5.4a2.87 2.87 0 0 1 2.5-3.1h.5a10.87 10.87 0 0 1 1.8.1v2.1h-1.3c-1 0-1.1.5-1.1 1.1v1.5h2.3l-.3 2.3h-2v5.9h3.9a.88.88 0 0 0 .9-.8V.8a.86.86 0 0 0-.8-.8z"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li class="mr-3">
                <a href="https://www.youtube.com/github" title="GitHub on YouTube" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.17 13.6" class="d-block" height="16">
                        <path
                            d="M18.77 2.13A2.4 2.4 0 0 0 17.09.42C15.59 0 9.58 0 9.58 0a57.55 57.55 0 0 0-7.5.4A2.49 2.49 0 0 0 .39 2.13 26.27 26.27 0 0 0 0 6.8a26.15 26.15 0 0 0 .39 4.67 2.43 2.43 0 0 0 1.69 1.71c1.52.42 7.5.42 7.5.42a57.69 57.69 0 0 0 7.51-.4 2.4 2.4 0 0 0 1.68-1.71 25.63 25.63 0 0 0 .4-4.67 24 24 0 0 0-.4-4.69zM7.67 9.71V3.89l5 2.91z"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li class="mr-3 flex-self-start">
                <a href="https://www.linkedin.com/company/github" title="GitHub on Linkedin" style="color: #959da5;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19 18" class="d-block" height="18">
                        <path
                            d="M3.94 2A2 2 0 1 1 2 0a2 2 0 0 1 1.94 2zM4 5.48H0V18h4zm6.32 0H6.34V18h3.94v-6.57c0-3.66 4.77-4 4.77 0V18H19v-7.93c0-6.17-7.06-5.94-8.72-2.91z"
                            fill="currentColor"></path>
                    </svg>
                </a>
            </li>
            <li>
                <a href="https://github.com/github" title="GitHub's organization" style="color: #959da5;">
                    <svg version="1.1" width="20" height="20" viewBox="0 0 16 16" class="octicon octicon-mark-github"
                        aria-hidden="true">
                        <path fill-rule="evenodd"
                            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                        </path>
                    </svg>
                </a>
            </li>
        </ul>
        <ul class="list-style-none d-flex text-gray">
            <li class="mr-3">&copy; 
                <script type="text/javascript">document.write(new Date().getFullYear());</script> GitHub, Inc.</li>
            <li class="mr-3"><a
                    href="https://docs.github.com/github/site-policy/github-terms-of-service"
                    class="link-gray">Terms </a></li>
            <li><a href="https://docs.github.com/github/site-policy/github-privacy-statement"
                    class="link-gray">Privacy </a></li>
        </ul>
    </div>
</div>
</main>

<script type="text/javascript">
    $(document).ready(function () {
        $(".toggle > *").hide();
        $(".toggle .name").show();
        $(".toggle .name").click(function () {
            $(this).parent().children().not(".name").toggle(400);
            $(this).parent().children(".name").toggleClass("open");
        })
    });
</script>

  </body>
</html>